# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Test Lemonade on NPU and Hybrid with OGA environment ðŸŒ©ï¸

on:
  push:
    branches: ["main"]
    paths:
      - '**.py'
      - '**.yml'
  pull_request:
    paths:
      - '**.py'
      - '**.yml'
  merge_group:
    paths:
      - '**.py'
      - '**.yml'
  workflow_dispatch:
    inputs:
      runson:
        description: 'Which runner group to run the workflow on'
        default: 'stx'
        required: true
        type: choice
        options:
        - 'stx'
        - 'stx-test'

permissions:
  contents: read

jobs:
  test-npu-and-hybrid:
    env:
        LEMONADE_CI_MODE: "True"
    runs-on: ["${{ inputs.runson || 'stx' }}", 'Windows']
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v3
      
      - name: Cleanup processes
        uses: ./.github/actions/cleanup-processes-windows
      
      - name: Setup Python and virtual environment
        uses: ./.github/actions/setup-venv
        with:
          venv-name: '.venv'
          python-version: '3.12'
          
      - name: Install dependencies
        shell: PowerShell
        run: |
          $ErrorActionPreference = "Stop"
          
          $venvPython = ".\.venv\Scripts\python.exe"
          $venvPip = ".\.venv\Scripts\pip.exe"
          
          & $venvPython -m pip install --upgrade pip
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          & $venvPip install pylint
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          & $venvPython -m pip check
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          # Install using PyPI approach for v1.5.0+
          & $venvPip install -e .[dev]
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          # Install ryzenai as a separate step to minimize use of pypi.amd.com
          & $venvPip install -e .[oga-ryzenai] --extra-index-url https://pypi.amd.com/simple
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          $cwd = (Get-Item .\).FullName
          echo "HF_HOME=$cwd\hf-cache" >> $Env:GITHUB_ENV

      - name: Run NPU tests
        shell: PowerShell
        env:
          HF_HOME: "${{ env.HF_HOME }}"
          LEMONADE_CACHE_DIR: ".\\ci-cache"
        run: |
          $ErrorActionPreference = "Stop"
          
          $venvPython = ".\.venv\Scripts\python.exe"
          $venvActivate = ".\.venv\Scripts\Activate.ps1"

          # Test CLI
          & $venvActivate
          lemonade -i amd/Llama-3.2-1B-Instruct-onnx-ryzenai-npu -d .\ci-cache oga-load --device npu --dtype int4 llm-prompt -p "Alice and Bob" --max-new-tokens 10
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          # Test high-level APIs
          & $venvPython examples/api_oga_npu.py
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          & $venvPython examples/api_oga_npu_streaming.py
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Run Hybrid tests
        shell: PowerShell
        env:
          HF_HOME: "${{ env.HF_HOME }}"
          LEMONADE_CACHE_DIR: ".\\ci-cache"
        run: |
          $ErrorActionPreference = "Stop"
          
          $venvPython = ".\.venv\Scripts\python.exe"
          $venvActivate = ".\.venv\Scripts\Activate.ps1"

          # Test CLI
          & $venvActivate
          lemonade -m -i amd/Llama-3.2-1B-Instruct-onnx-ryzenai-hybrid oga-load --device hybrid --dtype int4 llm-prompt -p "Alice and Bob" --max-new-tokens 10
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          # Test high-level APIs
          & $venvPython examples/api_oga_hybrid.py
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          & $venvPython examples/api_oga_hybrid_streaming.py
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
