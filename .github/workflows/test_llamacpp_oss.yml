name: Test Lemonade with Llamacpp ðŸŒ©ï¸

# Note: STX Halo / ROCm / Ubuntu jobs are disabled until we can
# add the required runners

on:
  push:
    branches: ["main"]
    paths:
      - '**.py'
      - '**.yml'
  pull_request:
    paths:
      - '**.py'
      - '**.yml'
  merge_group:
    paths:
      - '**.py'
      - '**.yml'
  workflow_dispatch:


permissions:
  contents: read

jobs:
  test-server-llamacpp-windows:
    env:
      LEMONADE_CI_MODE: "True"
      LEMONADE_CACHE_DIR: ./ci-cache
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      PYTHONIOENCODING: utf-8

    strategy:
      matrix:
        include:
          - backend: vulkan
            runner: [stx, Windows]
          - backend: rocm
            runner: [stx-halo, Windows]

    runs-on: ${{ matrix.runner }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.backend }}-${{ matrix.runner }}
      cancel-in-progress: true
    defaults:
      run:
        shell: powershell

    steps:
      - uses: actions/checkout@v3

      - name: Cleanup processes
        uses: ./.github/actions/cleanup-processes-windows

      - name: Setup Python and virtual environment
        uses: ./.github/actions/setup-venv
        with:
          venv-name: '.venv'
          python-version: '3.10'

      - name: Install dependencies
        run: |
          $ErrorActionPreference = "Stop"
          $venvPython = ".\.venv\Scripts\python.exe"
          $venvPip = ".\.venv\Scripts\pip.exe"
          
          & $venvPython -m pip install --upgrade pip
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          & $venvPip install pylint
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          & $venvPip install -e .[dev]
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          
          & $venvPip check
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          echo "HF_HOME=$(pwd)/hf-cache" >> $env:GITHUB_ENV

      - name: Run lemonade Llamacpp CLI tests
        env:
          HF_HOME: "${{ env.HF_HOME }}"
        run: |
          $venvLemonade = ".\.venv\Scripts\lemonade.exe"
          
          if ("${{ matrix.backend }}" -ne "rocm") {
            & $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} --device cpu llm-prompt -p "Hi" --max-new-tokens 10; if ($LASTEXITCODE -ne 0) { exit 1 }
          }

          & $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} --device igpu llm-prompt -p "Hi" --max-new-tokens 10; if ($LASTEXITCODE -ne 0) { exit 1 }
          & $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} llamacpp-bench --cli -w 0 -i 2; if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Run lemonade Llamacpp API tests
        env:
          HF_HOME: "${{ env.HF_HOME }}"
        run: |
          $venvPython = ".\.venv\Scripts\python.exe"
          
          & $venvPython test/server_llamacpp.py ${{ matrix.backend }}; if ($LASTEXITCODE -ne 0) { exit 1 }
          & $venvPython test/server_llamacpp.py ${{ matrix.backend }} --offline; if ($LASTEXITCODE -ne 0) { exit 1 }

  test-server-llamacpp-ubuntu:
    if: false  # Temporarily disabled due to unkillable D-state processes with GPU drivers
    env:
      LEMONADE_CI_MODE: "True"
      LEMONADE_CACHE_DIR: ./ci-cache
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

    strategy:
      matrix:
        include:
          - backend: rocm
            runner: [stx-halo, Linux]
          - backend: vulkan
            runner: [stx, Linux]

    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v3

      - name: Cleanup processes
        uses: ./.github/actions/cleanup-processes-linux

      - name: Setup Python and virtual environment
        uses: ./.github/actions/setup-venv
        with:
          venv-name: '.venv'
          python-version: '3.10'

      - name: Install dependencies
        run: |
          venvPython=".venv/bin/python"
          venvPip=".venv/bin/pip"
          $venvPython -m pip install --upgrade pip
          $venvPip install pylint
          $venvPip install -e .[dev]
          $venvPip check

          echo "HF_HOME=$(pwd)/hf-cache" >> $GITHUB_ENV

      - name: Run lemonade Llamacpp CLI tests
        env:
          HF_HOME: "${{ env.HF_HOME }}"
        run: |
          venvLemonade=".venv/bin/lemonade"
          if [ "${{ matrix.backend }}" != "rocm" ]; then
            $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} --device cpu llm-prompt -p "Hi" --max-new-tokens 10 || exit 1
          fi

          $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} --device igpu llm-prompt -p "Hi" --max-new-tokens 10 || exit 1
          $venvLemonade -i unsloth/Qwen3-0.6B-GGUF:Q4_0 llamacpp-load --backend ${{ matrix.backend }} llamacpp-bench -i 2 --output-tokens 16 || exit 1

      - name: Run lemonade Llamacpp API tests
        env:
          HF_HOME: "${{ env.HF_HOME }}"
        run: |
          venvPython=".venv/bin/python"
          $venvPython test/server_llamacpp.py ${{ matrix.backend }} || exit 1
          $venvPython test/server_llamacpp.py ${{ matrix.backend }} --offline || exit 1

  test-server-llamacpp-macos:
    env:
      LEMONADE_CI_MODE: "True"
      LEMONADE_CACHE_DIR: ./ci-cache
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

    strategy:
      matrix:
        python-version: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && fromJSON('["3.10", "3.12"]') || fromJSON('["3.12"]') }}
        backend: ['metal']

    runs-on: macos-latest
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v3

      - name: Cleanup processes
        uses: ./.github/actions/cleanup-processes-linux

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create virtual environment and install dependencies
        run: |
          python -m venv .venv
          venvPip=".venv/bin/pip"
          $venvPip install -e .[dev]
          $venvPip check

          echo "HF_HOME=$(pwd)/hf-cache" >> $GITHUB_ENV

      - name: Run lemonade Llamacpp API tests (Metal)
        env:
          HF_HOME: "${{ env.HF_HOME }}"
        run: |
          venvPython=".venv/bin/python"
          $venvPython test/server_llamacpp.py metal || exit 1
          $venvPython test/server_llamacpp.py metal --offline || exit 1
