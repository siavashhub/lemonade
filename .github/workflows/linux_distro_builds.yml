name: Linux Distro Builds üêß

on:
  push:
    branches: ["main"]
  pull_request:
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux:
    name: Build on ${{ matrix.distro }}
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: Arch
            image: archlinux:latest
            python: python
          - distro: Debian
            image: debian:trixie
            python: python3
          - distro: Fedora
            image: fedora:latest
            python: python3

    steps:
      - name: Install build dependencies
        run: |
          set -e

          if [ "${{ matrix.distro }}" = "Arch" ]; then
            echo "Updating Arch package database..."
            pacman -Syu --noconfirm

            echo "Installing build dependencies..."
            pacman -S --noconfirm --needed \
              base-devel \
              cmake \
              git \
              curl \
              openssl \
              zlib \
              pkgconf \
              python \
              python-pip \
              ca-certificates \
              procps-ng

          elif [ "${{ matrix.distro }}" = "Debian" ]; then
            echo "Updating Debian package database..."
            apt-get update

            echo "Installing build dependencies..."
            apt-get install -y \
              build-essential \
              g++ \
              cmake \
              git \
              curl \
              libcurl4-openssl-dev \
              libssl-dev \
              zlib1g-dev \
              pkg-config \
              python3 \
              python3-pip \
              python3-venv \
              ca-certificates \
              procps

          elif [ "${{ matrix.distro }}" = "Fedora" ]; then
            echo "Updating Fedora package database..."
            dnf update -y

            echo "Installing build dependencies..."
            dnf install -y \
              @development-tools \
              gcc-c++ \
              cmake \
              git \
              curl \
              libcurl-devel \
              openssl-devel \
              zlib-devel \
              pkgconf \
              python3 \
              python3-pip \
              ca-certificates \
              procps-ng
          fi

          echo "Verifying installations..."
          cmake --version
          gcc --version
          g++ --version
          pkg-config --version
          ${{ matrix.python }} --version

          echo "Verifying process management tools..."
          command -v pgrep && command -v pkill && command -v ps

          echo "Verifying SSL certificates..."
          ls -la /etc/ssl/certs/ | head -10

          echo "Testing HTTPS connectivity..."
          curl -sI https://huggingface.co | head -5 || echo "Warning: HTTPS test failed"

          echo "Build dependencies installed successfully!"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Build C++ Server with CMake
        run: |
          set -e

          echo "Building lemonade-router and lemonade-server on ${{ matrix.distro }}..."

          cd src/cpp

          # Create build directory
          if [ -d "build" ]; then
              echo "Removing existing build directory..."
              rm -rf build
          fi
          mkdir build
          cd build

          # Configure with Release build type
          echo "Configuring CMake..."
          cmake .. -DCMAKE_BUILD_TYPE=Release

          # Build using all available cores
          echo "Building binaries..."
          cmake --build . -j$(nproc)

          # Verify binaries exist
          if [ ! -f "lemonade-router" ]; then
              echo "ERROR: lemonade-router not found!"
              echo "Build directory contents:"
              ls -lh
              exit 1
          fi

          if [ ! -f "lemonade-server" ]; then
              echo "ERROR: lemonade-server not found!"
              echo "Build directory contents:"
              ls -lh
              exit 1
          fi

          echo "Binaries found successfully"
          ls -lh lemonade-router lemonade-server

          echo "Verifying binary executability..."
          ./lemonade-router --version
          ./lemonade-server --version

          echo "${{ matrix.distro }} build successful!"

      - name: Verify system library linking
        run: |
          echo "Checking library dependencies..."
          cd src/cpp/build

          echo "=== lemonade-router dependencies ==="
          ldd lemonade-router

          echo ""
          echo "=== lemonade-server dependencies ==="
          ldd lemonade-server

          echo ""
          echo "All dependencies resolved successfully on ${{ matrix.distro }}!"

      - name: Setup Python virtual environment
        run: |
          echo "Creating Python virtual environment..."
          ${{ matrix.python }} -m venv .venv

          echo "Activating virtual environment and installing dependencies..."
          . .venv/bin/activate
          pip install --upgrade pip
          pip install -r test/requirements.txt

          echo "Python environment setup complete!"

      - name: Run CLI tests
        env:
          LEMONADE_CI_MODE: "True"
          PYTHONIOENCODING: utf-8
        run: |
          set -e

          . .venv/bin/activate
          SERVER_BINARY="$(pwd)/src/cpp/build/lemonade-server"

          echo "Running CLI tests..."
          python test/server_cli.py --server-binary "$SERVER_BINARY"

          echo "CLI tests PASSED!"

      - name: Run endpoint tests
        env:
          LEMONADE_CI_MODE: "True"
          PYTHONIOENCODING: utf-8
        run: |
          set -e

          . .venv/bin/activate
          SERVER_BINARY="$(pwd)/src/cpp/build/lemonade-server"

          echo "Running endpoint tests..."
          python test/server_endpoints.py --server-binary "$SERVER_BINARY"

          echo "Endpoint tests PASSED!"
